<!DOCTYPE html>
<html>
<head>
    <title>Global Prayer Map</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet/dist/leaflet.css"
    />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <style>
        #map {
            height: 90vh;
        }

        /* Popup base */
        .leaflet-popup-content {
            font-size: 16px;
            line-height: 1.4;
            min-width: 220px;
        }

        .pray-btn {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            background-color: #2e7d32;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        .pray-btn:active {
            background-color: #1b5e20;
        }

        .pray-success {
            margin-top: 10px;
            padding: 10px;
            background: #e8f5e9;
            color: #1b5e20;
            border-radius: 6px;
            font-size: 15px;
            text-align: center;
        }

        /* Mobile tweaks */
        @media (max-width: 600px) {
            h2 {
                font-size: 20px;
            }

            p {
                font-size: 14px;
            }

            .leaflet-popup-content {
                font-size: 18px;
                min-width: 260px;
            }

            .pray-btn {
                font-size: 18px;
                padding: 14px;
            }
        }
        .popup-content {
            position: relative;
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .popup-content .close-x {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
        }
    /* ===== Mobile popup override ===== */
    @media (max-width: 600px) {

        /* Contenedor del popup de Leaflet */
        .leaflet-popup-content-wrapper {
            border-radius: 12px;
        }

        .leaflet-popup-content {
            font-size: 20px !important;
            min-width: 300px !important;
            max-width: 90vw !important;
            padding: 16px !important;
        }

        .popup-content {
            padding: 16px;
            font-size: 18px;
        }

        .popup-content p {
            font-size: 18px;
            margin-bottom: 16px;
        }

        .pray-btn,
        #closePopup {
            font-size: 18px;
            padding: 14px;
            width: 100%;
            margin-top: 10px;
        }

        .close-x {
            font-size: 26px;
            top: 6px;
            right: 8px;
        }
    }

    /* ===== Country labels on map ===== */
    .country-label {
        background: none;
        border: none;
        box-shadow: none;
        color: #111;
        font-weight: 400;
        font-size: 12px;
        text-shadow:
            -1px -1px 0 #fff,
             1px -1px 0 #fff,
            -1px  1px 0 #fff,
             1px  1px 0 #fff;
    }

    @media (max-width: 600px) {
        .country-label {
            font-size: 14px;
        }
    }
    </style>
</head>
<body>

<h2>Or치 por las naciones</h2>
<p>Los colores muestran cu치nta oraci칩n recibe cada pa칤s.</p>

<div id="map"></div>

<script>
    // Inicializar mapa
    var map = L.map('map').setView([20, 0], 2);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '춸 OpenStreetMap'
    }).addTo(map);

    // Datos desde Django
    const countryData = {
        {% for c in countries %}
            "{{ c.iso_code }}": {{ c.prayer_count }},
        {% endfor %}
    };

    function getColor(count) {
        if (count === undefined) return '#ccc';
        if (count < 5) return '#ff4d4d';     // rojo
        if (count < 20) return '#ffd633';    // amarillo
        return '#66cc66';                    // verde
    }

    function prayForCountry(iso3, name, buttonEl) {
        buttonEl.disabled = true;
        //buttonEl.innerText = "Gracias 游똂";

        fetch(`/pray/${iso3}/`, {
            method: "POST",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}",
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                name: name
            })
        })
        .then(res => res.json())
        .then(data => {
            const msg = document.createElement("div");
            msg.className = "pray-success";
            msg.innerHTML = `
            <div class="popup-content">
                <button class="close-x">&times;</button> <!-- Bot칩n de cerrar en la esquina -->
                <p>游똂 Oraci칩n registrada por ${data.name}</p>
                <button id="closePopup">Cerrar</button>
            </div>
            `;

             // Agregar el popup al contenedor principal del mapa
    
            buttonEl.closest(".leaflet-popup-content").appendChild(msg);

            // Manejar el cierre del popup
              // Manejar el cierre del popup
            const closePopup = document.getElementById("closePopup");
            closePopup.addEventListener("click", () => {
                msg.remove(); // Eliminar el popup
                location.reload(); // Recargar la p치gina
            });

             // Manejar el cierre del popup con la "X" en la esquina
            const closeX = msg.querySelector(".close-x");
            closeX.addEventListener("click", () => {
                msg.remove(); // Eliminar el popup
                location.reload(); // Recargar la p치gina
            });

         /*    setTimeout(() => {
                location.reload();
            }, 1200); */
        });
    }

    
    // Overrides manuales para labels de pa칤ses grandes cruzando el 180춿
    const labelOverrides = {
        "USA": [39.8, -98.6],   // Centro continental EEUU
        "RUS": [61.5, 105.3],   // Siberia central
        "ARG": [-38.4, -63.6],  // Centro visual de Argentina
    };

    // Cargar pa칤ses y pintarlos
    fetch('https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json')
        .then(res => res.json())
        .then(data => {
            L.geoJson(data, {
                style: function (feature) {
                    const iso3 = feature.id; // ISO-3 real del GeoJSON (ARG, USA, etc.)
                    const count = countryData[iso3];

                    return {
                        fillColor: getColor(count),
                        weight: 1,
                        opacity: 1,
                        color: '#333',
                        fillOpacity: 0.7
                    };
                },
                onEachFeature: function (feature, layer) {
                    const iso3 = feature.id;
                    const count = countryData[iso3];
                    let countryName =
                        feature.properties.name ||
                        feature.properties.NAME ||
                        feature.properties.ADMIN ||
                        iso3;

                    // Ajuste de nombres sensibles / localizaci칩n
                    if (iso3 === "FLK") {
                        countryName = "Islas Malvinas";
                    }

                    layer.bindPopup(`
                        <strong>${countryName}</strong><br/>
                        ${count !== undefined ? 'Oraciones: ' + count : 'Sin oraciones a칰n'}<br/><br/>
                        <button class="pray-btn"
                                data-iso="${iso3}"
                                data-name="${encodeURIComponent(countryName)}">
                            Me comprometo a orar 游똂
                        </button>
                    `);

                    const override = labelOverrides[iso3];

                    if (override) {
                        const labelMarker = L.marker(override, {
                            icon: L.divIcon({
                                className: "country-label",
                                html: countryName,
                            }),
                            interactive: false
                        }).addTo(map);
                    } else {
                        layer.bindTooltip(countryName, {
                            permanent: true,
                            direction: "center",
                            className: "country-label",
                            opacity: 0.9
                        });
                    }

                    layer.on("popupopen", function (e) {
                        const btn = e.popup._contentNode.querySelector(".pray-btn");
                        if (btn) {
                            btn.addEventListener("click", function () {
                                prayForCountry(
                                    this.dataset.iso,
                                    decodeURIComponent(this.dataset.name),
                                    this
                                );
                            });
                        }
                    });
                }
            }).addTo(map);
        });
</script>

</body>
</html>