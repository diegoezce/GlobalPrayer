<!DOCTYPE html>
<html>
<head>
    <title>Global Prayer Map</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet/dist/leaflet.css"
    />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI',
                         Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', Arial,
                         sans-serif;
            margin: 0;
            padding: 0;
        }
        #map {
            height: 90vh;
        }

        /* Popup base */
        .leaflet-popup-content {
            font-size: 16px;
            line-height: 1.4;
            min-width: 220px;
        }

        .pray-btn {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            background-color: #2e7d32;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        .pray-btn:active {
            background-color: #1b5e20;
        }

        .pray-success {
            margin-top: 10px;
            padding: 10px;
            background: #e8f5e9;
            color: #1b5e20;
            border-radius: 6px;
            font-size: 15px;
            text-align: center;
        }

        /* Mobile tweaks */
        @media (max-width: 600px) {
            h2 {
                font-size: 20px;
            }

            p {
                font-size: 14px;
            }

            .leaflet-popup-content {
                font-size: 18px;
                min-width: 260px;
            }

            .pray-btn {
                font-size: 18px;
                padding: 14px;
            }
        }
        .popup-content {
            position: relative;
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .popup-content .close-x {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
        }
    /* ===== Mobile popup override ===== */
    @media (max-width: 600px) {

        /* Contenedor del popup de Leaflet */
        .leaflet-popup-content-wrapper {
            border-radius: 12px;
        }

        .leaflet-popup-content {
            font-size: 20px !important;
            min-width: 300px !important;
            max-width: 90vw !important;
            padding: 16px !important;
        }

        .popup-content {
            padding: 16px;
            font-size: 18px;
        }

        .popup-content p {
            font-size: 18px;
            margin-bottom: 16px;
        }

        .pray-btn,
        #closePopup {
            font-size: 18px;
            padding: 14px;
            width: 100%;
            margin-top: 10px;
        }

        .close-x {
            font-size: 26px;
            top: 6px;
            right: 8px;
        }
    }

    /* ===== Country labels on map ===== */
    .country-label {
        background: none;
        border: none;
        box-shadow: none;
        color: #111;
        font-weight: 400;
        font-size: 12px;
        text-shadow:
            -1px -1px 0 #fff,
             1px -1px 0 #fff,
            -1px  1px 0 #fff,
             1px  1px 0 #fff;
    }

    @media (max-width: 600px) {
        .country-label {
            font-size: 14px;
        }
    }

    /* ===== Welcome modal ===== */
#welcome-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.45);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
}

#welcome-modal {
        background: white;
        max-width: 420px;
        width: 90%;
        padding: 24px;
        border-radius: 12px;
        text-align: center;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
}

#welcome-modal h3 {
        margin-top: 0;
        font-size: 20px;
        font-weight: 600;
}

#welcome-modal p {
        font-size: 15px;
        line-height: 1.5;
        margin: 12px 0;
}

#welcome-modal button {
        margin-top: 16px;
        padding: 12px;
        width: 100%;
        font-size: 16px;
        background: #2e7d32;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
}
#menu-btn {
    position: fixed;
    top: 12px;
    right: 12px;
    z-index: 9000;
    background: white;
    border: none;
    border-radius: 50%;
    width: 44px;
    height: 44px;
    font-size: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.25);
    cursor: pointer;
}
#rankings-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.45);
    z-index: 9998;
    display: flex;
    align-items: center;
    justify-content: center;
}

#rankings-modal {
    background: white;
    width: 90%;
    max-width: 420px;
    max-height: 80vh;
    overflow-y: auto;
    padding: 20px;
    border-radius: 12px;
}

#rankings-modal h4 {
    margin-top: 16px;
}

#rankings-modal ul {
    list-style: none;
    padding: 0;
}

#rankings-modal li {
    padding: 6px 0;
    display: flex;
    justify-content: space-between;
}
    </style>
</head>
<body>

<button id="menu-btn">üìä</button>

<div id="welcome-overlay">
    <div id="welcome-modal">
        <h3>üåç Global Prayer</h3>

        <p>
            A simple global map where anyone can commit to pray for a country.
            No registration required. This is between you and God.
        </p>

        <p>
            Un mapa global simple donde cualquier persona puede comprometerse a orar por un pa√≠s.
            No se requiere registro. Esto es entre t√∫ y Dios.
        </p>

        <button id="welcome-close">üôè Start praying</button>
    </div>
</div>

<h2>üåç Global Prayer</h2>
<p>Tap a country ‚Ä¢ Pray üôè</p>

<div id="rankings-overlay" style="display:none;">
    <div id="rankings-modal">
        <h3>üìä Rankings</h3>

        <h4>üåç Needs Prayer</h4>
        <ul id="needs-list"></ul>

        <h4>üôè Most Prayed For</h4>
        <ul id="most-list"></ul>

        <button id="rankings-close">Close</button>
    </div>
</div>

<div id="map"></div>

<script>
    // Inicializar mapa
    var map = L.map('map').setView([20, 0], 2);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap'
    }).addTo(map);

    // Datos desde Django
    const countryData = {
        {% for c in countries %}
            "{{ c.iso_code }}": {{ c.prayer_count }},
        {% endfor %}
    };
    const countryNames = {};

    function getColor(count) {
        if (count === undefined) return '#ccc';
        if (count < 5) return '#ff4d4d';     // rojo
        if (count < 20) return '#ffd633';    // amarillo
        return '#66cc66';                    // verde
    }

    function prayForCountry(iso3, name, buttonEl) {
        buttonEl.disabled = true;
        //buttonEl.innerText = "Gracias üôè";

        fetch(`/pray/${iso3}/`, {
            method: "POST",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}",
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                name: name
            })
        })
        .then(res => res.json())
        .then(data => {
            const msg = document.createElement("div");
            msg.className = "pray-success";
            msg.innerHTML = `
            <div class="popup-content">
                <button class="close-x">&times;</button> <!-- Bot√≥n de cerrar en la esquina -->
                <p>üôè Thank you</p>
                <button id="closePopup">Close</button>
            </div>
            `;

             // Agregar el popup al contenedor principal del mapa
    
            buttonEl.closest(".leaflet-popup-content").appendChild(msg);

            // Manejar el cierre del popup
              // Manejar el cierre del popup
            const closePopup = document.getElementById("closePopup");
            closePopup.addEventListener("click", () => {
                msg.remove(); // Eliminar el popup
                location.reload(); // Recargar la p√°gina
            });

             // Manejar el cierre del popup con la "X" en la esquina
            const closeX = msg.querySelector(".close-x");
            closeX.addEventListener("click", () => {
                msg.remove(); // Eliminar el popup
                location.reload(); // Recargar la p√°gina
            });

         /*    setTimeout(() => {
                location.reload();
            }, 1200); */
        });
    }

    
    // Overrides manuales para labels de pa√≠ses grandes cruzando el 180¬∞
    const labelOverrides = {
        "USA": [39.8, -98.6],   // Centro continental EEUU
        "RUS": [61.5, 105.3],   // Siberia central
        "ARG": [-38.4, -63.6],  // Centro visual de Argentina
    };

    // Cargar pa√≠ses y pintarlos
    fetch('https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json')
        .then(res => res.json())
        .then(data => {
            L.geoJson(data, {
                style: function (feature) {
                    const iso3 = feature.id; // ISO-3 real del GeoJSON (ARG, USA, etc.)
                    const count = countryData[iso3];

                    return {
                        fillColor: getColor(count),
                        weight: 1,
                        opacity: 1,
                        color: '#333',
                        fillOpacity: 0.7
                    };
                },
                onEachFeature: function (feature, layer) {
                    const iso3 = feature.id;
                    const count = countryData[iso3];
                    let countryName =
                        feature.properties.name ||
                        feature.properties.NAME ||
                        feature.properties.ADMIN ||
                        iso3;
                    countryNames[iso3] = countryName;

                    // Ajuste de nombres sensibles / localizaci√≥n
                    if (iso3 === "FLK") {
                        countryName = "Islas Malvinas";
                    }

                    layer.bindPopup(`
                        <strong>${countryName}</strong><br/>
                        ${count !== undefined ? 'Prayers: ' + count : 'No prayers yet'}<br/><br/>
                        <button class="pray-btn"
                                data-iso="${iso3}"
                                data-name="${encodeURIComponent(countryName)}">
                            üôè Pray
                        </button>
                    `);

                    const override = labelOverrides[iso3];

                    if (override) {
                        const labelMarker = L.marker(override, {
                            icon: L.divIcon({
                                className: "country-label",
                                html: countryName,
                            }),
                            interactive: false
                        }).addTo(map);
                    } else {
                        layer.bindTooltip(countryName, {
                            permanent: true,
                            direction: "center",
                            className: "country-label",
                            opacity: 0.9
                        });
                    }

                    layer.on("popupopen", function (e) {
                        const btn = e.popup._contentNode.querySelector(".pray-btn");
                        if (btn) {
                            btn.addEventListener("click", function () {
                                prayForCountry(
                                    this.dataset.iso,
                                    decodeURIComponent(this.dataset.name),
                                    this
                                );
                            });
                        }
                    });
                }
            }).addTo(map);
        });
    document.addEventListener("DOMContentLoaded", function () {
        const overlay = document.getElementById("welcome-overlay");
        const closeBtn = document.getElementById("welcome-close");

        closeBtn.addEventListener("click", function () {
            overlay.remove();
        });
    });

document.getElementById("menu-btn").addEventListener("click", () => {
    const overlay = document.getElementById("rankings-overlay");
    overlay.style.display = "flex";

    const entries = Object.entries(countryData);

    const sortedAsc = [...entries].sort((a,b) => a[1] - b[1]).slice(0,10);
    const sortedDesc = [...entries].sort((a,b) => b[1] - a[1]).slice(0,10);

    document.getElementById("needs-list").innerHTML =
        sortedAsc.map(([iso,count]) =>
            `<li><span>${countryNames[iso] || iso}</span><span>${count}</span></li>`
        ).join("");

    document.getElementById("most-list").innerHTML =
        sortedDesc.map(([iso,count]) =>
            `<li><span>${countryNames[iso] || iso}</span><span>${count}</span></li>`
        ).join("");
});

document.getElementById("rankings-close").addEventListener("click", () => {
    document.getElementById("rankings-overlay").style.display = "none";
});
</script>

</body>
</html>
        h2 {
            font-weight: 600;
            letter-spacing: -0.02em;
        }